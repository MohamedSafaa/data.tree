---
title: "AHP Car Example"
author: "Christoph Glur"
date: '`r Sys.Date()`'
output:
  html_document:
    theme: united
    toc: yes
    toc_depth: 4
  pdf_document:
    highlight: tango
    toc: yes
    toc_depth: 4
vignette: |
  %\VignetteIndexEntry{Vignette Title} %\VignetteEngine{knitr::rmarkdown} \usepackage[utf8]{inputenc}
---

## Introduction

In this example, the Jones family wants to buy a new car.
This document follows the [Wikipedia AHP Car Example](http://en.wikipedia.org/wiki/Analytic_hierarchy_process_%E2%80%94_Car_example). Even though a few details are different, the original article is required to follow along.

## Creating the AHP criteria tree

When deciding which car to buy, the family considers the following criteria: cost, safety, style, and capacity, and their sub-criteria. Using the ahp package, the ahp hierarchy tree can be constructed like so:

```{r tidy=FALSE}
library(ahp)
goal <- AhpNode$new("Car")
  cost <- goal$AddChild("Cost")
    purchasePrice <- cost$AddChild("Purchase Price")
    fuelCosts <- cost$AddChild("Fuel Costs")
    maintenanceCosts <- cost$AddChild("Maintenance Costs")
    resaleValue <- cost$AddChild("Resale Value")
  safety <- goal$AddChild("Safety")
    curbWeight <- safety$AddChild("Curb Weight")
    safetyClass <- safety$AddChild("Safety Class")
    crashRating <- safety$AddChild("Crash Rating")
  style <- goal$AddChild("Style")
  capacity <- goal$AddChild("Capacity")
    cargoCapacity <- capacity$AddChild("Cargo Capacity")
    passengerCapacity <- capacity$AddChild("Passenger Capacity")

#as.Node(goal)
goal
```

## Criteria

What is more important, style or safety? AHP allows expressing an individual's or a group's opinion by polling the pairwise preferences on a scale of 1 to 9, and their inverse. 1 means two categories are equally important. 9 means A is strictly preferred to B. 1/9 means B is strictly preferrable to A.

In order to apply the AHP algorithm in order to calculate the *priorities*, one needs to construct a *preference matrix*. The ahp package, however, provides a utility method to construct such a matrix.

### Setting the Preferences

We start by setting the level one criteria preferences. These are:

```{r}
names(goal$children)
```


Since AHP requires setting preferences for each pairwise combination of criteria, the ahp package provides a utility method to quickly list all such pairwise preferences:

```{r}
pp <- goal$GetChildCombinations()
pp
```

Note that, by default, all preferences are set to 1. The cost criteria, say, is equally important as the style criteria. This is, however, not the case for the Jones family. So we now fill the pairwise preferences, as perceived by the Jones':

```{r}
pp <- setPreference(pp, "Cost"   , "Safety"  , 3) #For the Jones family, cost is more important than safety
pp <- setPreference(pp, "Cost"   , "Style"   , 7) #cost is much more important than style
pp <- setPreference(pp, "Cost"   , "Capacity", 3) #cost is more important than capacity
pp <- setPreference(pp, "Safety" , "Style"   , 9)
pp <- setPreference(pp, "Safety" , "Capacity", 1) #safety and capacity are equally important
pp <- setPreference(pp, "Style"  , "Capacity", 1/7) #capacity is much more important than style
```

A technical side node: you may have realised that `pp`, the pairwise child combinations of our categories, is a standard `data.frame`, and not an R6 reference class. As a result, we must re-assign `pp`, using e.g. `pp <- setPreference(pp, "Cost"   , "Safety"  , 3)`.

From the pairwise preferences, we create the ahp preference matrix:

```{r}
preferenceMatrix <- AhpMatrix(pp)
preferenceMatrix
```

This matrix has 1's along the diagonal, obviously, and for preferences $P$ the following holds true $P_{i,j}=\frac{1}{P_{j,i}}  \forall i,j$

### Calculating the Priorities

From the *preference matrix*, we can directly calculate the *priorities* by using the AHP algorithm. The `AhpNode` class provides this functionality out of the box. All we need to do is to set the preference matrix in the ahp tree, on the parent node. This will then automatically calculate the level 1 priorities:

```{r}
goal$SetChildPreferenceMatrix(preferenceMatrix)
```

The level 1 priorities have now been calculated for us:

```{r}
priorities(goal)
```

As preferences are expressed *pairwise*, it is possible that our preferences are inconsistent. The AHP algorithm introduces a consistency measure to check whether our pairwise preferences make sense. This consistency measure is obtained like this:

```{r}
goal$childConsistency
```

Remember that the lower the consistency, the better.

The ahp tree now looks like this:

```{r}
goal
```

## Sub-Criteria

### Cost

The AHP tree looks still incomplete. We need to set pairwise preferences for each combination, at each node. Let us continue with the preferences of the sub-categories below the *Cost* node:


```{r}
pp <- goal$Find("Cost")$GetChildCombinations()
print(pp)

pp <- setPreference(pp, "Purchase Price"   , "Fuel Costs"       , 2)
pp <- setPreference(pp, "Purchase Price"   , "Maintenance Costs", 5)
pp <- setPreference(pp, "Purchase Price"   , "Resale Value"     , 3)
pp <- setPreference(pp, "Fuel Costs"       , "Maintenance Costs", 2)
pp <- setPreference(pp, "Fuel Costs"       , "Resale Value"     , 2)
pp <- setPreference(pp, "Maintenance Costs", "Resale Value"     , 1/2)

preferenceMatrix <- AhpMatrix(pp)
goal$Find("Cost")$SetChildPreferenceMatrix(preferenceMatrix)

priorities(goal$Find("Cost"))
```

Note that the sum of the priorities is equal to 1:

```{r}
sum(priorities(goal$Find("Cost")))
```

Our AHP tree looks already a bit more complete:

```{r}
goal
```

We now need to do the same thing for Safety and Capacity. Note that we do not have to do anything for style, as style does not have sub-criteria.

### Safety

This should be straight forward by now:

```{r}
pp <- goal$Find("Safety")$GetChildCombinations()
pp

pp <- setPreference(pp, "Curb Weight"   , "Safety Class", 3)
pp <- setPreference(pp, "Curb Weight"   , "Crash Rating", 2)
pp <- setPreference(pp, "Safety Class"  , "Crash Rating", 1/2)

preferenceMatrix <- AhpMatrix(pp)
goal$Find("Safety")$SetChildPreferenceMatrix(preferenceMatrix)

goal$Find("Safety")

```

### Capacity

```{r}
pp <- goal$Find("Capacity")$GetChildCombinations()
pp

pp <- setPreference(pp, "Cargo Capacity", "Passenger Capacity", 1/5)
preferenceMatrix <- AhpMatrix(pp)
goal$Find("Capacity")$SetChildPreferenceMatrix(preferenceMatrix)
```

Our AHP tree now looks like this:

```{r}
goal
```

We establish that consistency is acceptable everywhere, and that for example purchase price is roughly six times more important than cargo capacity.

## Alternatives

We are now ready to move to the next steps: Alternatives.

The Jones family has researched and has 6 cars on their shortlist.

```{r}
accord_sedan <- AhpAlternative$new("Accord Sedan")
accord_hybrid <- AhpAlternative$new("Accord Hybrid")
pilot <- AhpAlternative$new("Pilot SUV")
crv <- AhpAlternative$new("CR-V SUV")
element <- AhpAlternative$new("Element SUV")
odyssey <- AhpAlternative$new("Odyssey Minivan")

alternatives <-  list(accord_sedan,
                     accord_hybrid,
                     pilot,
                     crv,
                     element,
                     odyssey
                     )
```

We add these alternatives to the goal:

```{r}
goal$AddAlternatives(alternatives)
```

This method adds each alternative to each leaf-category. Our AHP tree now looks like this:

```{r}
head(as.data.frame(goal), 20)
```

The next step is to set our alternative-preferences for each category. Let us start with the purchase price.

### Cost

#### Purchase Price

We start by adding a custom attribute, price, to each alternative:

```{r}
accord_sedan$price <- 20360
accord_hybrid$price <- 31090
pilot$price <- 27595
crv$price <- 20700
element$price <- 18980
odyssey$price <- 25645
```

According to the Jones family, the pairwise preference with respect to the purchase price depends on the absolute price of each car, but also on the price difference between two cars.  If the price is above 26000 USD, we shun it. If the price is above 25000 USD, we don't like it. Otherwise, if a car's price much cheaper then the other car, we like it.

We could now set the preferences according to these rules manually. Luckily, though, the ahp package provides us with a utility function, `CalculatePreferences`. This function sits on the `AhpNode`, and takes a function as an input. 

By convention, the function passed to `CalculatePreferences` must take two `Alternative` instances as input. It must return the pairwise preference in ahp manner (1/9, 1/8 ... 1/2, 1, 2, ... 9)

Note that, to keep it simple, the function we use is slightly different from the tutorial on wikipedia.

```{r}
purchasePricePreference <- function(car1, car2) {
  
  kSoftBudget <- 25000
  kHardBudget <- 26000
  
  if (car1$price > kHardBudget && car2$price > kHardBudget) {
    return (1)
  }
  
  if (car1$price <= kSoftBudget && car2$price > kHardBudget) {
    return (9)
  }
  
  if (car1$price <= kSoftBudget && car2$price > kSoftBudget) {
    return (7)
  }
  
  
  if (car1$price < car2$price) {
    pref <- max(1, min(9, round((car2$price - car1$price)/1000)))
    return (pref)
  }
  
  #looks like car2 is preferred
  return (1/purchasePricePreference(car2, car1))
  
}

```

Once we have defined the preference function , we pass it to the `CalculatePreferences` method

```{r}
goal$Find(c("Cost", "Purchase Price"))$CalculatePreferences(purchasePricePreference)

```

The node has automatically calculated the ahp preference matrix ...


```{r}
goal$Find(c("Cost", "Purchase Price"))$preferenceMatrix

```

... as well as the priorities:
```{r}
priorities(goal$Find(c("Cost", "Purchase Price")))

```


### Safety

Sticking to the somewhat odd order of the Wikipedia example, we now enter preferences for the Safety sub-categories. Note that in the Wikipedia example, the Safety sub-categories are all processed as a single category. However, thanks to the ahp facility, separating them into single sub-categories is very intuitive.
However, if you had rather follow the Wikipedia example, you should now be fit to do this on your own as an exercise.

#### Curb Weight

We first add the curb weight as a property to the `Alternative`:

```{r}
accord_sedan$curb_weight <- 3289
accord_hybrid$curb_weight <- 3501
pilot$curb_weight <- 4264
crv$curb_weight <- 3389
element$curb_weight <- 3433
odyssey$curb_weight <- 4385

```

The Jones' believe that a heavier car is safer. 
We use the ahp package utility function `LinearComparison`, assuming that the overall lightest existing car is 3000, and the heaviest ist 5000.
Note that we pass along additional parameters to the LinearComparison function.

```{r}
goal$Find(c("Safety", "Curb Weight"))$CalculatePreferences(LinearComparison, fieldName = "curb_weight", min_x = 3000, max_x = 5000)
```

This will, for example 
* give a preference of 9 to a car weighing 5000, if compared to an alternative weighing 3000
* give a preference of 5 to the heavier car if the weight difference is 1000

That's all there is to it. Our preferences are readily calculated:

```{r}
goal$Find(c("Safety", "Curb Weight"))
```

As expected, the heaviest car has the highest priority.
If the Jones' believe that this gives too much weight to the heaviest one, they could simply recalculate the preferences with different settings, e.g.

```{r}
goal$Find(c("Safety", "Curb Weight"))$CalculatePreferences(LinearComparison, fieldName = "curb_weight", min_x = 2000, max_x = 5500)
goal$Find(c("Safety", "Curb Weight"))
```

#### Safety Class

Safety class is a classification of cars. 
Let's start, again, by classifying our cars:

```{r}
accord_sedan$safetyClass <- "Midsize Car"
accord_hybrid$safetyClass <- "Midsize Car"
pilot$safetyClass <- "Midsize SUV"
crv$safetyClass <- "Small SUV"
element$safetyClass <- "Small SUV"
odyssey$safetyClass <- "Minivan"
```

Which safety class is to be preferred? This looks like an AHP problem in itself, and so we treat it as such:

```{r}
safetyClassGoal <- AhpNode$new("Safety Class Goal")
safetyClassGoal$AddChild("Midsize Car")
safetyClassGoal$AddChild("Midsize SUV")
safetyClassGoal$AddChild("Small SUV")
safetyClassGoal$AddChild("Minivan")

pp <- safetyClassGoal$GetChildCombinations()
pp

pp <- setPreference(pp, "Midsize Car", "Midsize SUV", 1/4)
pp <- setPreference(pp, "Midsize Car", "Small SUV"  , 1/2)
pp <- setPreference(pp, "Midsize Car", "Minivan"    , 2)
pp <- setPreference(pp, "Midsize SUV", "Small SUV"  , 3)
pp <- setPreference(pp, "Midsize SUV", "Minivan"    , 5)
pp <- setPreference(pp, "Small SUV"  , "Minivan"    , 2)

preferenceMatrix <- AhpMatrix(pp)
safetyClassGoal$SetChildPreferenceMatrix(preferenceMatrix)

priorities(safetyClassGoal)

```

We apply the preferenceMatrix to the Safety Class criteria in our original AHP tree. The method `ApplyPreferenceMatrix` makes sure that the preferences are inherited from the `safetyClassGoal`, according to the car `alternative$safetyClass`:

```{r}

goal$Find(c("Safety", "Safety Class"))$ApplyPreferenceMatrix(preferenceMatrix, 'safetyClass')
priorities(goal$Find(c("Safety", "Safety Class")))
```

Note that the second argument specifies the name of the property in our Alternatives list which contains the safety class.
